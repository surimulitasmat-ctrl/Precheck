<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PreCheck</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 16px;">
  <h2>PreCheck Demo</h2>

  <label>Store:</label>
  <select id="store">
    <option value="PDD">PDD</option>
    <option value="SKH">SKH</option>
  </select>

  <br><br>

  <label>Staff:</label>
  <input id="staff" placeholder="e.g. 59 - suri" />

  <br><br>

  <h3>Items</h3>
  <div id="items">Loading...</div>

  <h3>Expiry Alerts (expired / today)</h3>
  <ul id="expiry"></ul>

  <script>
    async function loadItems() {
      const res = await fetch("/api/items");
      const items = await res.json();

      const container = document.getElementById("items");
      container.innerHTML = "";

      items.forEach(it => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ddd";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";

        div.innerHTML = `
          <b>${it.name}</b> <small>(${it.category})</small><br><br>
          Qty: <input type="number" id="q_${it.id}" style="width:60px;">
          Expiry: <input type="date" id="e_${it.id}">
          <button onclick="saveLog(${it.id})">Save</button>
          <div id="m_${it.id}" style="font-size:12px;color:#666;margin-top:6px;"></div>
        `;
        container.appendChild(div);
      });
    }

    async function saveLog(itemId) {
      const store = document.getElementById("store").value;
      const staff = document.getElementById("staff").value.trim();
      if (!staff) return alert("Please enter staff first");

      const quantity = document.getElementById(`q_${itemId}`).value;
      const expiry = document.getElementById(`e_${itemId}`).value;

      document.getElementById(`m_${itemId}`).innerText = "Saving...";

      const res = await fetch("/api/log", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ store, staff, item_id: itemId, quantity, expiry })
      });

      if (!res.ok) {
        document.getElementById(`m_${itemId}`).innerText = "Error saving";
        return;
      }

      document.getElementById(`m_${itemId}`).innerText = "Saved ✅";
      loadExpiry();
    }

    async function loadExpiry() {
      const store = document.getElementById("store").value;
      const res = await fetch(`/api/expiry?store=${store}`);
      const data = await res.json();

      const ul = document.getElementById("expiry");
      ul.innerHTML = data.length ? "" : "<li>None ✅</li>";

      data.forEach(x => {
        const li = document.createElement("li");
        li.innerText = `${x.name} — Qty: ${x.quantity} — Exp: ${x.expiry}`;
        ul.appendChild(li);
      });
    }

    document.getElementById("store").addEventListener("change", loadExpiry);

    loadItems();
    loadExpiry();
  </script>
</body>
</html>
